<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DockPorts - å®¹å™¨ç«¯å£ç›‘æ§</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        overflow-x: hidden;
        width: 100%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.1) 25%,
            transparent 25%
          ),
          linear-gradient(-45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.1) 75%),
          linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.1) 75%),
          linear-gradient(
            135deg,
            #e6f3ff 0%,
            #f0f8ff 30%,
            #e8f4f8 70%,
            #f5f7fa 100%
          );
        background-size: 20px 20px, 20px 20px, 20px 20px, 20px 20px, 100% 100%;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px, 0 0;
        min-height: 100vh;
        color: #333;
        padding: 0 20px;
        box-sizing: border-box;
      }

      .header {
        background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
        color: white;
        padding: 2rem 0;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1000;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      /* ç”¨æˆ·ç•Œé¢æ ·å¼ */
      .user-info {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 0.5rem 1rem;
        border-radius: 12px;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        z-index: 1001;
      }

      .user-info:hover {
        background: rgba(255, 255, 255, 0.35);
      }

      .user-role {
        background: rgba(255, 255, 255, 0.3);
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .user-menu-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .user-menu-btn:hover {
        transform: rotate(180deg);
      }

      .user-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        min-width: 180px;
        z-index: 1002;
        margin-top: 0.75rem;
        display: none;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .user-menu button {
        display: block;
        width: 100%;
        padding: 0.75rem 1.25rem;
        border: none;
        background: none;
        text-align: left;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s ease;
      }

      .user-menu button:hover {
        background: #f8fafc;
        padding-left: 1.5rem;
      }

      .user-menu button:last-child {
        border-bottom: none;
      }

      /* æ¨¡æ€æ¡†é€šç”¨æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        animation: modalFadeIn 0.3s ease;
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2.5rem;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        position: relative;
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
      }

      .modal-header h3 {
        font-weight: 600;
        color: #2d3748;
        font-size: 1.5rem;
      }

      .close {
        cursor: pointer;
        font-size: 1.5rem;
        color: #a0aec0;
        transition: color 0.2s ease;
      }

      .close:hover {
        color: #4a5568;
      }

      .error {
        color: #e53e3e;
        background: #fed7d7;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
        font-size: 0.9rem;
        border-left: 4px solid #e53e3e;
      }

      /* è¡¨å•æ ·å¼ */
      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #4a5568;
        font-size: 0.9rem;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(66, 153, 225, 0.2);
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #3182ce 0%, #2c5aa0 100%);
        box-shadow: 0 6px 12px rgba(66, 153, 225, 0.3);
        transform: translateY(-2px);
      }

      .btn-primary:disabled {
        background: #a0aec0;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .btn-secondary:hover {
        background: #cbd5e0;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .main-container {
        display: flex;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 0;
        gap: 2rem;
        width: calc(100% - 40px);
        box-sizing: border-box;
      }

      .sidebar {
        width: 250px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        height: fit-content;
        backdrop-filter: blur(10px);
      }

      .sidebar h3 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        color: #4a5568;
      }

      .tab-list {
        list-style: none;
      }

      .tab-item {
        margin-bottom: 0.5rem;
      }

      .tab-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        color: #718096;
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid transparent;
      }

      .tab-link:hover {
        background: #f7fafc;
        color: #4a5568;
      }

      .tab-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #5a67d8;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tab-icon {
        margin-right: 0.5rem;
        font-size: 1.1rem;
      }

      /* ç«¯å£èŒƒå›´é”å®šæ ·å¼ */
      .port-range-lock {
        margin-top: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .port-range-lock h4 {
        margin: 0 0 1rem 0;
        color: #4a5568;
        font-size: 1rem;
      }

      .range-inputs {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .input-group label {
        font-size: 0.85rem;
        color: #718096;
        font-weight: 500;
      }

      .input-group input {
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: border-color 0.2s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .lock-controls {
        display: flex;
        gap: 0.5rem;
      }

      .lock-btn,
      .reset-btn {
        flex: 1;
        padding: 0.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
        font-weight: 500;
      }

      .lock-btn {
        background: #667eea;
        color: white;
      }

      .lock-btn:hover {
        background: #5a67d8;
      }

      .lock-btn.locked {
        background: #48bb78;
      }

      .lock-btn.locked:hover {
        background: #38a169;
      }

      .reset-btn {
        background: #e2e8f0;
        color: #4a5568;
      }

      .reset-btn:hover {
        background: #cbd5e0;
      }

      .lock-btn.locked {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
      }

      .lock-btn.locked:hover {
        background-color: #c82333;
        border-color: #bd2130;
      }

      .input-group input:disabled {
        background-color: #e9ecef;
        opacity: 0.6;
        cursor: not-allowed;
      }

      .container {
        flex: 1;
      }

      .controls {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 1rem;
        backdrop-filter: blur(10px);
        width: 100%;
        box-sizing: border-box;
      }

      .controls-left {
        flex: 0 0 auto;
      }

      .controls-center {
        flex: 1;
        display: flex;
        justify-content: center;
      }

      .filter-controls {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .toggle-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: space-between;
      }

      .controls-right {
        flex: 0 0 auto;
      }

      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .action-buttons button {
        width: 120px;
        min-width: 120px;
        white-space: nowrap;
      }

      .view-toggle {
        display: flex;
        background: #f7fafc;
        border-radius: 8px;
        padding: 0.25rem;
      }

      .view-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        color: #718096;
      }

      .view-btn.active {
        background: white;
        color: #4a5568;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .protocol-toggle {
        display: flex;
        background: #f7fafc;
        border-radius: 8px;
        padding: 0.25rem;
      }

      .protocol-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        color: #718096;
        font-size: 0.9rem;
      }

      .protocol-btn.active {
        background: white;
        color: #4a5568;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .protocol-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.5);
      }

      /* å“åº”å¼å¸ƒå±€ */
      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
          padding: 1rem 0;
          gap: 1rem;
        }

        .sidebar {
          width: 100%;
          order: 2;
        }

        .container {
          order: 1;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
          gap: 1.5rem;
        }

        .controls-left,
        .controls-center,
        .controls-right {
          width: 100%;
        }

        .controls-center {
          justify-content: stretch;
        }

        .filter-controls {
          flex-direction: column;
          align-items: stretch;
          gap: 1rem;
        }

        .toggle-row {
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
        }

        .action-buttons {
          flex-direction: row;
          justify-content: center;
          gap: 1rem;
        }

        .stats {
          justify-content: center;
          gap: 1rem;
        }

        /* ç§»åŠ¨ç«¯ç”¨æˆ·ä¿¡æ¯è°ƒæ•´ */
        .user-info {
          position: relative;
          top: auto;
          right: auto;
          margin: 1rem auto;
          width: fit-content;
        }
      }

      .stats {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #5a67d8;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.25rem;
      }

      .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .refresh-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .settings-btn {
        background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .settings-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      /* è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
      .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2d3748;
      }

      .config-section {
        margin-bottom: 2rem;
      }

      .config-section h3 {
        font-size: 1.2rem;
        color: #4a5568;
        margin-bottom: 1rem;
      }

      .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .config-item {
        display: flex;
        flex-direction: column;
      }

      .config-item label {
        font-size: 0.9rem;
        color: #4a5568;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .config-item input {
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .config-item input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
      }

      .ports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
      }

      @media (min-width: 1400px) {
        .ports-grid {
          grid-template-columns: repeat(6, 1fr);
        }
      }

      @media (min-width: 1200px) and (max-width: 1399px) {
        .ports-grid {
          grid-template-columns: repeat(5, 1fr);
        }
      }

      @media (min-width: 900px) and (max-width: 1199px) {
        .ports-grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      .port-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 2px solid transparent;
        backdrop-filter: blur(10px);
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
      }

      .port-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      }

      .port-list-item {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-left: 4px solid #e2e8f0;
        backdrop-filter: blur(10px);
      }

      .port-list-item:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .list-view .ports-grid {
        display: block;
      }

      .list-view .port-card {
        display: none;
      }

      .card-view .port-list-item {
        display: none;
      }

      .port-card.used {
        border-color: #48bb78;
      }

      .port-card.gap {
        background: #f7fafc;
        border-color: #e2e8f0;
        color: #718096;
      }

      .port-card.docker {
        border-color: #4299e1;
      }

      .port-card.system {
        border-color: #48bb78;
      }

      .port-number {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
      }

      .port-card.used .port-number {
        color: #48bb78;
      }

      .port-card.docker .port-number {
        color: #4299e1;
      }

      .port-card.system .port-number {
        color: #48bb78;
      }

      .port-card.gap .port-number {
        color: #a0aec0;
        font-size: 1.2rem;
      }

      .container-name {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      .container-port {
        font-size: 0.6rem;
        color: #999;
        margin-top: 0.2rem;
      }

      .port-display {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .host-port {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.1rem;
        color: #4299e1;
      }

      .mapped-port {
        font-size: 0.6rem;
        color: #999;
        font-weight: normal;
      }

      .process-name {
        font-size: 0.8rem;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      .service-name {
        font-size: 0.8rem;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      .tooltip {
        position: relative;
        cursor: help;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: auto;
        min-width: 120px;
        max-width: 300px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute;
        z-index: 1000;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      .gap-info {
        font-size: 0.8rem;
        color: #718096;
        line-height: 1.2;
        margin: 0.2rem 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .port-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 0.5rem;
      }

      .port-card-center {
        flex: 1;
        text-align: center;
      }

      .port-card-actions {
        display: flex;
        gap: 0.5rem;
      }

      .port-source-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        background: #e2e8f0;
        color: #4a5568;
        font-weight: 500;
      }

      .port-source-badge.docker {
        background: #bee3f8;
        color: #2b6cb0;
      }

      .port-source-badge.system {
        background: #c6f6d5;
        color: #2f855a;
      }

      .port-source-badge.hidden {
        background: #a0aec0;
        color: white;
      }

      .port-card.hidden {
        background: #f7fafc;
        border-color: #e2e8f0;
        opacity: 0.8;
      }

      .port-list-item.hidden {
        background: #f7fafc;
        opacity: 0.8;
      }

      .port-card.virtual {
        border: 2px dashed #6c757d;
        background-color: #f8f9fa;
      }

      .port-list-item.virtual {
        border-left: 4px dashed #6c757d;
        background-color: #f8f9fa;
      }

      .add-port-btn {
        background: #48bb78;
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .add-port-btn:hover {
        background: #38a169;
        transform: scale(1.1);
      }

      .hide-port-btn {
        background: #a0aec0;
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .hide-port-btn:hover {
        background: #718096;
        transform: scale(1.1);
      }

      .list-add-btn {
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
      }

      .list-hide-btn {
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
      }

      .user-management-table {
        width: 100%;
        border-collapse: collapse;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        overflow: hidden;
      }

      .user-management-table th,
      .user-management-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
      }

      .user-management-table th {
        background: #f7fafc;
        font-weight: 600;
        color: #4a5568;
      }

      .user-management-table tr:last-child td {
        border-bottom: none;
      }

      .user-management-table tr:hover {
        background: #f7fafc;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: white;
      }

      .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid white;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fed7d7;
        color: #c53030;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: center;
      }

      .add-port-btn {
        background: #4299e1;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .add-port-btn:hover {
        background: #3182ce;
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .list-add-btn {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }

      .port-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .edit-modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-width: 400px;
        width: 90%;
      }

      .edit-modal h3 {
        margin: 0 0 1rem 0;
        color: #2d3748;
      }

      .edit-modal input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 1rem;
        box-sizing: border-box;
      }

      .edit-modal input:focus {
        outline: none;
        border-color: #4299e1;
      }

      .edit-modal-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
      }

      .edit-modal button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s;
      }

      .edit-modal .save-btn {
        background: #48bb78;
        color: white;
      }

      .edit-modal .save-btn:hover {
        background: #38a169;
      }

      .edit-modal .cancel-btn {
        background: #e2e8f0;
        color: #4a5568;
      }

      .edit-modal .cancel-btn:hover {
        background: #cbd5e0;
      }

      .badge {
        display: flex;
        align-items: center;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        height: 20px;
        line-height: 20px;
      }

      .port-protocol-info {
        display: flex;
        gap: 0.3rem;
        margin: 0.3rem 0;
        flex-wrap: wrap;
      }

      .protocol-badge {
        font-size: 0.7rem;
        color: #4a5568;
        background: #e2e8f0;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 500;
        height: 20px;
        display: flex;
        align-items: center;
      }

      .ip-version-badge {
        font-size: 0.7rem;
        color: #2d3748;
        background: #f0f4f8;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 500;
        height: 20px;
        display: flex;
        align-items: center;
      }

      .badge.docker {
        background: #bee3f8;
        color: #2b6cb0;
      }

      .badge.system {
        background: #c6f6d5;
        color: #276749;
      }

      .search-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .search-input {
        padding: 0.5rem 2rem 0.5rem 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        width: 100%;
        transition: border-color 0.2s;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .clear-search-btn {
        position: absolute;
        right: 0.5rem;
        background: none;
        border: none;
        color: #a0aec0;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 0.25rem;
        border-radius: 50%;
        transition: color 0.2s;
      }

      .clear-search-btn:hover {
        color: #718096;
        background: #f7fafc;
      }
    </style>
  </head>
  <body>
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header"><h3>ç™»å½•</h3></div>
        <div id="loginError" class="error"></div>
        <div class="form-group">
          <label>ç”¨æˆ·å</label><input type="text" id="loginUser" />
        </div>
        <div class="form-group">
          <label>å¯†ç </label><input type="password" id="loginPass" />
        </div>
        <button
          class="btn btn-primary"
          style="width: 100%"
          onclick="performLogin()"
        >
          ç™»å½•
        </button>
      </div>
    </div>

    <div class="header">
      <h1>DockPorts</h1>
      <p>å®¹å™¨ç«¯å£ç›‘æ§ä¸å¯è§†åŒ–å·¥å…·</p>
      <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
      <div id="userInfoContainer"></div>
    </div>

    <div class="main-container">
      <div class="sidebar">
        <h3>ğŸ“Š ç«¯å£åˆ†ç±»æ£€ç´¢</h3>
        <ul class="tab-list">
          <li class="tab-item">
            <a class="tab-link active" data-filter="all">
              <span class="tab-icon">ğŸ“‹</span>
              å…¨éƒ¨
            </a>
          </li>
          <li class="tab-item">
            <a class="tab-link" data-filter="system">
              <span class="tab-icon">âš™ï¸</span>
              å®¿ä¸»æœº
            </a>
          </li>
          <li class="tab-item">
            <a class="tab-link" data-filter="container">
              <span class="tab-icon">ğŸ³</span>
              å®¹å™¨
            </a>
          </li>
          <li class="tab-item">
            <a class="tab-link" data-filter="unused">
              <span class="tab-icon">ğŸ”“</span>
              æœªä½¿ç”¨
            </a>
          </li>
          <li class="tab-item">
            <a class="tab-link" data-filter="hidden">
              <span class="tab-icon">ğŸ‘ï¸â€ğŸ—¨ï¸</span>
              å·²éšè—
            </a>
          </li>
        </ul>

        <!-- ç«¯å£èŒƒå›´é”å®šåŠŸèƒ½ -->
        <div class="port-range-lock">
          <h4>ğŸ”’ ç«¯å£èŒƒå›´é”å®š</h4>
          <div class="range-inputs">
            <div class="input-group">
              <label for="startPort">èµ·å§‹ç«¯å£:</label>
              <input
                type="number"
                id="startPort"
                placeholder="0"
                min="0"
                max="65535"
              />
            </div>
            <div class="input-group">
              <label for="endPort">ç»“æŸç«¯å£:</label>
              <input
                type="number"
                id="endPort"
                placeholder="65535"
                min="0"
                max="65535"
              />
            </div>
          </div>
          <div class="lock-controls">
            <button
              id="lockRangeBtn"
              class="lock-btn"
              onclick="togglePortRangeLock()"
            >
              ğŸ”“ é”å®š
            </button>
            <button
              id="resetRangeBtn"
              class="reset-btn"
              onclick="resetPortRange()"
            >
              ğŸ”„ è§£é”
            </button>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="controls">
          <div class="controls-left">
            <div class="stats">
              <div class="stat-item">
                <div class="stat-number" id="totalUsed">-</div>
                <div class="stat-label">å·²ä½¿ç”¨ç«¯å£</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="totalAvailable">-</div>
                <div class="stat-label">å¯ç”¨ç«¯å£</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="dockerContainers">-</div>
                <div class="stat-label">Dockerå®¹å™¨</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="tcpUsed">-</div>
                <div class="stat-label">TCPç«¯å£</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="udpUsed">-</div>
                <div class="stat-label">UDPç«¯å£</div>
              </div>
            </div>
          </div>
          <div class="controls-center">
            <div class="filter-controls">
              <div class="toggle-row">
                <div class="protocol-toggle">
                  <button class="protocol-btn active" data-protocol="all">
                    å…¨éƒ¨
                  </button>
                  <button class="protocol-btn" data-protocol="tcp">TCP</button>
                  <button class="protocol-btn" data-protocol="udp">UDP</button>
                </div>
                <div class="view-toggle">
                  <button class="view-btn active" data-view="card">
                    ğŸ”² å¡ç‰‡
                  </button>
                  <button class="view-btn" data-view="list">ğŸ“‹ åˆ—è¡¨</button>
                </div>
              </div>
              <div class="search-container">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="æœç´¢ç«¯å£ã€è¿›ç¨‹ã€æœåŠ¡..."
                  class="search-input"
                />
                <button id="clearSearch" class="clear-search-btn">âœ•</button>
              </div>
            </div>
          </div>
          <div class="controls-right">
            <div class="action-buttons">
              <button
                class="refresh-btn"
                onclick="refreshPorts()"
                id="refreshBtn"
              >
                ğŸ”„ åˆ·æ–°
              </button>
              <button
                id="settingsBtn"
                class="settings-btn"
                onclick="openSettings()"
              >
                âš™ï¸ è®¾ç½®
              </button>
            </div>
          </div>
        </div>

        <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <p>æ­£åœ¨åŠ è½½ç«¯å£ä¿¡æ¯...</p>
        </div>

        <div id="error" class="error" style="display: none"></div>

        <div
          id="portsContainer"
          class="ports-grid card-view"
          style="display: none"
        >
          <!-- ç«¯å£ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
      </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ç³»ç»Ÿè®¾ç½®</h2>
          <span class="close" onclick="closeSettings()">&times;</span>
        </div>

        <div class="config-section">
          <h3>é…ç½®æ–‡ä»¶ç¼–è¾‘</h3>
          <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem">
            ç›´æ¥ç¼–è¾‘ config.json æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒä¸­æ–‡æœåŠ¡åç§°
          </p>

          <textarea
            id="configEditor"
            style="
              width: 100%;
              height: 300px;
              font-family: 'Courier New', monospace;
              font-size: 0.9rem;
              padding: 1rem;
              border: 1px solid #e2e8f0;
              border-radius: 6px;
              resize: vertical;
            "
            placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„JSONé…ç½®..."
          ></textarea>
          <div
            id="configError"
            style="
              color: #e53e3e;
              font-size: 0.8rem;
              margin-top: 0.5rem;
              display: none;
            "
          ></div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeSettings()">
            å–æ¶ˆ
          </button>
          <button class="btn btn-primary" onclick="saveSettings()">
            ä¿å­˜è®¾ç½®
          </button>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div id="changePasswordModal" class="modal">
      <div class="modal-content" style="max-width: 450px">
        <div class="modal-header">
          <h3>ä¿®æ”¹å¯†ç </h3>
          <span class="close" onclick="closeModal('changePasswordModal')"
            >&times;</span
          >
        </div>
        <div id="cpError" class="error"></div>
        <div class="form-group">
          <label>å½“å‰å¯†ç </label><input type="password" id="cpCurrent" />
        </div>
        <div class="form-group">
          <label>æ–°å¯†ç  (è‡³å°‘6ä½)</label
          ><input type="password" id="cpNew" oninput="validatePwd()" />
        </div>
        <div class="form-group">
          <label>ç¡®è®¤æ–°å¯†ç </label
          ><input type="password" id="cpConfirm" oninput="validatePwd()" />
        </div>
        <div id="pwdMatchMsg" style="font-size: 0.8rem; height: 1.2rem"></div>
        <div style="text-align: right; margin-top: 1rem">
          <button
            class="btn btn-secondary"
            onclick="closeModal('changePasswordModal')"
          >
            å–æ¶ˆ
          </button>
          <button
            class="btn btn-primary"
            id="btnChangePwd"
            onclick="submitChangePassword()"
            disabled
          >
            æäº¤ä¿®æ”¹
          </button>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="userManagementModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ç”¨æˆ·ç®¡ç†</h3>
          <span class="close" onclick="closeModal('userManagementModal')"
            >&times;</span
          >
        </div>
        <div id="umError" class="error"></div>
        <div
          style="
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
          "
        >
          <h4>æ·»åŠ ç”¨æˆ·</h4>
          <div
            style="
              display: flex;
              gap: 1rem;
              margin-top: 0.75rem;
              flex-wrap: wrap;
            "
          >
            <input
              type="text"
              id="newUmUser"
              placeholder="ç”¨æˆ·å"
              style="flex: 1; min-width: 120px"
            />
            <input
              type="password"
              id="newUmPass"
              placeholder="å¯†ç "
              style="flex: 1; min-width: 120px"
            />
            <select id="newUmRole" style="flex: 1; min-width: 120px">
              <option value="user">æ™®é€šç”¨æˆ·</option>
              <option value="admin">ç®¡ç†å‘˜</option>
            </select>
            <button class="btn btn-primary" onclick="createUser()">æ·»åŠ </button>
          </div>
        </div>
        <div id="usersList"></div>
      </div>
    </div>

    <script>
      // è®¤è¯ç›¸å…³å˜é‡å’Œå‡½æ•°
      let currentUser = null;
      let isLoading = false;
      let portsData = [];
      let hiddenPorts = [];
      let currentFilter = "all";
      let currentView = "card";
      let currentProtocol = "all";
      let searchTimeout = null;

      // ç«¯å£èŒƒå›´é”å®šç›¸å…³å˜é‡
      let isPortRangeLocked = false;
      let lockedStartPort = 0;
      let lockedEndPort = 65535;

      // --- åˆå§‹åŒ–ä¸è®¤è¯ ---

      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        initializeEventListeners();

        // å…¨å±€ç‚¹å‡»å…³é—­æ¨¡æ€æ¡†
        window.onclick = function (event) {
          if (
            event.target.classList.contains("modal") &&
            event.target.id !== "loginModal"
          ) {
            event.target.style.display = "none";
          }
        };
      });

      async function checkAuth() {
        try {
          const res = await fetch("/api/auth/check");
          const data = await res.json();
          if (data.logged_in) {
            currentUser = data.user;
            updateHeader();
            loadHiddenPorts().then(loadPorts);
          } else {
            document.getElementById("loginModal").style.display = "block";
          }
        } catch (e) {
          console.error("Auth check failed", e);
          document.getElementById("loginModal").style.display = "block";
        }
      }

      async function performLogin() {
        const u = document.getElementById("loginUser").value;
        const p = document.getElementById("loginPass").value;
        try {
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u, password: p }),
          });
          const data = await res.json();
          if (data.success) {
            currentUser = data.user;
            document.getElementById("loginModal").style.display = "none";
            updateHeader();
            loadHiddenPorts().then(loadPorts);
          } else {
            showError("loginError", data.error);
          }
        } catch (e) {
          showError("loginError", "ç½‘ç»œé”™è¯¯");
        }
      }

      async function logout() {
        await fetch("/api/auth/logout", { method: "POST" });
        location.reload();
      }

      function updateHeader() {
        const container = document.getElementById("userInfoContainer");
        if (currentUser) {
          container.innerHTML = `
                    <div class="user-info">
                        <span>${currentUser.username}</span>
                        <span class="user-role">${
                          currentUser.role === "admin" ? "ç®¡ç†å‘˜" : "ç”¨æˆ·"
                        }</span>
                        <button class="user-menu-btn" onclick="toggleMenu()">â–¼</button>
                        <div id="userMenu" class="user-menu">
                            <button onclick="openChangePassword()">ä¿®æ”¹å¯†ç </button>
                            ${
                              currentUser.role === "admin"
                                ? '<button onclick="openUserManagement()">ç”¨æˆ·ç®¡ç†</button>'
                                : ""
                            }
                            <button onclick="logout()" style="color: #e53e3e">é€€å‡ºç™»å½•</button>
                        </div>
                    </div>
                `;
        } else {
          container.innerHTML = "";
        }
      }

      function toggleMenu() {
        const m = document.getElementById("userMenu");
        m.style.display = m.style.display === "block" ? "none" : "block";
      }

      // --- ç”¨æˆ·ç®¡ç†é€»è¾‘ ---

      function openUserManagement() {
        if (currentUser.role !== "admin") return alert("æƒé™ä¸è¶³");
        document.getElementById("userManagementModal").style.display = "block";
        // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
        clearError("umError");
        loadUsersList();
      }

      async function loadUsersList() {
        const res = await fetch("/api/auth/users");
        const data = await res.json();
        const list = document.getElementById("usersList");
        if (data.success) {
          list.innerHTML = `
                    <table class="user-management-table">
                        <thead><tr><th>ç”¨æˆ·</th><th>è§’è‰²</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                        <tbody>
                            ${data.users
                              .map(
                                (u) => `
                                <tr>
                                    <td>${u.username}</td>
                                    <td>${u.role}</td>
                                    <td>${
                                      u.created_at
                                        ? u.created_at.split("T")[0]
                                        : "-"
                                    }</td>
                                    <td>
                                        ${
                                          u.username !== currentUser.username
                                            ? `<button style="color:red; border:none; background:none; cursor:pointer" onclick="deleteUser('${u.username}')">åˆ é™¤</button>`
                                            : ""
                                        }
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                `;
        }
      }

      async function createUser() {
        const u = document.getElementById("newUmUser").value;
        const p = document.getElementById("newUmPass").value;
        const r = document.getElementById("newUmRole").value;

        // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
        clearError("umError");

        const res = await fetch("/api/auth/users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: u, password: p, role: r }),
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById("newUmUser").value = "";
          document.getElementById("newUmPass").value = "";
          loadUsersList();
        } else {
          showError("umError", data.error);
        }
      }

      async function deleteUser(username) {
        if (!confirm(`ç¡®å®šåˆ é™¤ ${username}?`)) return;
        const res = await fetch(`/api/auth/users/${username}`, {
          method: "DELETE",
        });
        const data = await res.json();
        if (data.success) loadUsersList();
        else alert(data.error);
      }

      // --- ä¿®æ”¹å¯†ç é€»è¾‘ ---

      function openChangePassword() {
        document.getElementById("cpCurrent").value = "";
        document.getElementById("cpNew").value = "";
        document.getElementById("cpConfirm").value = "";
        // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
        clearError("cpError");
        document.getElementById("pwdMatchMsg").innerText = "";
        document.getElementById("btnChangePwd").disabled = true;
        document.getElementById("changePasswordModal").style.display = "block";
        document.getElementById("userMenu").style.display = "none";
      }

      function validatePwd() {
        const n = document.getElementById("cpNew").value;
        const c = document.getElementById("cpConfirm").value;
        const msg = document.getElementById("pwdMatchMsg");
        const btn = document.getElementById("btnChangePwd");

        if (n.length < 6) {
          msg.innerText = "å¯†ç é•¿åº¦è‡³å°‘6ä½";
          msg.style.color = "red";
          btn.disabled = true;
          return;
        }

        if (n !== c) {
          msg.innerText = "ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´";
          msg.style.color = "red";
          btn.disabled = true;
        } else {
          msg.innerText = "å¯†ç ä¸€è‡´";
          msg.style.color = "green";
          btn.disabled = false;
        }
      }

      async function submitChangePassword() {
        const curr = document.getElementById("cpCurrent").value;
        const n = document.getElementById("cpNew").value;
        const btn = document.getElementById("btnChangePwd");

        // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
        clearError("cpError");

        btn.disabled = true;
        btn.innerText = "æäº¤ä¸­...";

        try {
          const res = await fetch("/api/auth/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ current_password: curr, new_password: n }),
          });
          const data = await res.json();

          if (data.success) {
            alert("å¯†ç ä¿®æ”¹æˆåŠŸ");
            closeModal("changePasswordModal");
          } else {
            showError("cpError", data.error);
          }
        } catch (e) {
          showError("cpError", "è¯·æ±‚å¤±è´¥");
        } finally {
          btn.disabled = false;
          btn.innerText = "æäº¤ä¿®æ”¹";
        }
      }

      // --- å·¥å…·å‡½æ•° ---

      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }

      function showError(elementId, msg) {
        const el = document.getElementById(elementId);
        if (el) {
          el.innerText = msg;
          el.style.display = "block";
          setTimeout(() => (el.style.display = "none"), 3000);
        } else {
          console.error(`Element with id ${elementId} not found`);
        }
      }

      function clearError(elementId) {
        const el = document.getElementById(elementId);
        if (el) {
          el.innerText = "";
          el.style.display = "none";
        }
      }

      /**
       * æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«éšè—
       */
      function isPortHidden(card) {
        if (card.type === "gap") {
          for (let port = card.start_port; port <= card.end_port; port++) {
            if (!hiddenPorts.includes(port)) {
              return false;
            }
          }
          return true;
        } else if (card.type === "unknown_range") {
          for (let port = card.start_port; port <= card.end_port; port++) {
            if (hiddenPorts.includes(port)) {
              return true;
            }
          }
          return false;
        } else {
          return hiddenPorts.includes(card.port);
        }
      }

      // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
      function initializeEventListeners() {
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll(".tab-link").forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const filter = this.getAttribute("data-filter");
            switchTab(filter);
          });
        });

        // è§†å›¾æ¨¡å¼åˆ‡æ¢
        document.querySelectorAll(".view-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const view = this.getAttribute("data-view");
            switchView(view);
          });
        });

        // åè®®åˆ‡æ¢
        document.querySelectorAll(".protocol-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const protocol = this.getAttribute("data-protocol");
            switchProtocol(protocol);
          });
        });

        // æœç´¢åŠŸèƒ½
        const searchInput = document.getElementById("searchInput");
        const clearSearchBtn = document.getElementById("clearSearch");

        searchInput.addEventListener("input", function () {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            performSearch();
          }, 300);
        });

        searchInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            clearTimeout(searchTimeout);
            performSearch();
          }
        });

        clearSearchBtn.addEventListener("click", function () {
          searchInput.value = "";
          performSearch();
          searchInput.focus();
        });

        // ç«¯å£èŒƒå›´é”å®šåŠŸèƒ½
        const lockRangeBtn = document.getElementById("lockRangeBtn");
        const resetRangeBtn = document.getElementById("resetRangeBtn");

        if (lockRangeBtn) {
          lockRangeBtn.addEventListener("click", togglePortRangeLock);
        }

        if (resetRangeBtn) {
          resetRangeBtn.addEventListener("click", resetPortRange);
        }

        // ç«¯å£è¾“å…¥æ¡†å›è½¦é”®ç›‘å¬
        const startPortInput = document.getElementById("startPort");
        const endPortInput = document.getElementById("endPort");

        if (startPortInput) {
          startPortInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              togglePortRangeLock();
            }
          });
        }

        if (endPortInput) {
          endPortInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              togglePortRangeLock();
            }
          });
        }
      }

      // åˆ‡æ¢æ ‡ç­¾é¡µ
      function switchTab(filter) {
        currentFilter = filter;

        document.querySelectorAll(".tab-link").forEach((link) => {
          link.classList.remove("active");
        });
        document
          .querySelector(`[data-filter="${filter}"]`)
          .classList.add("active");

        displayPorts(filterPorts(portsData));
      }

      // åˆ‡æ¢è§†å›¾æ¨¡å¼
      function switchView(view) {
        currentView = view;

        document.querySelectorAll(".view-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.querySelector(`[data-view="${view}"]`).classList.add("active");

        const container = document.getElementById("portsContainer");
        container.className = `ports-grid ${view}-view`;

        displayPorts(filterPorts(portsData));
      }

      // åˆ‡æ¢åè®®è¿‡æ»¤å™¨
      function switchProtocol(protocol) {
        currentProtocol = protocol;

        document.querySelectorAll(".protocol-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`[data-protocol="${protocol}"]`)
          .classList.add("active");

        loadPorts();
      }

      /**
       * åˆ‡æ¢ç«¯å£èŒƒå›´é”å®šçŠ¶æ€
       */
      function togglePortRangeLock() {
        const startPortInput = document.getElementById("startPort");
        const endPortInput = document.getElementById("endPort");
        const lockBtn = document.getElementById("lockRangeBtn");

        if (!isPortRangeLocked) {
          const startPort = parseInt(startPortInput.value) || 0;
          const endPort = parseInt(endPortInput.value) || 65535;

          if (
            startPort < 0 ||
            startPort > 65535 ||
            endPort < 0 ||
            endPort > 65535
          ) {
            alert("ç«¯å£èŒƒå›´å¿…é¡»åœ¨ 0-65535 ä¹‹é—´");
            return;
          }

          if (startPort > endPort) {
            alert("èµ·å§‹ç«¯å£ä¸èƒ½å¤§äºç»“æŸç«¯å£");
            return;
          }

          isPortRangeLocked = true;
          lockedStartPort = startPort;
          lockedEndPort = endPort;

          lockBtn.textContent = "ğŸ”’ è§£é”èŒƒå›´";
          lockBtn.classList.add("locked");

          startPortInput.disabled = true;
          endPortInput.disabled = true;

          console.log(`ç«¯å£èŒƒå›´å·²é”å®š: ${lockedStartPort}-${lockedEndPort}`);
        } else {
          isPortRangeLocked = false;

          lockBtn.textContent = "ğŸ”“ é”å®šèŒƒå›´";
          lockBtn.classList.remove("locked");

          startPortInput.disabled = false;
          endPortInput.disabled = false;

          console.log("ç«¯å£èŒƒå›´å·²è§£é”");
        }

        loadPorts();
      }

      /**
       * é‡ç½®ç«¯å£èŒƒå›´
       */
      function resetPortRange() {
        const startPortInput = document.getElementById("startPort");
        const endPortInput = document.getElementById("endPort");
        const lockBtn = document.getElementById("lockRangeBtn");

        startPortInput.value = "";
        endPortInput.value = "";

        if (isPortRangeLocked) {
          isPortRangeLocked = false;
          lockBtn.textContent = "ğŸ”“ é”å®šèŒƒå›´";
          lockBtn.classList.remove("locked");
          startPortInput.disabled = false;
          endPortInput.disabled = false;
        }

        lockedStartPort = 0;
        lockedEndPort = 65535;

        console.log("ç«¯å£èŒƒå›´å·²é‡ç½®");

        loadPorts();
      }

      /**
       * æ£€æŸ¥ç«¯å£æ˜¯å¦åœ¨é”å®šèŒƒå›´å†…
       */
      function isPortInRange(card) {
        if (!isPortRangeLocked) {
          return true;
        }

        if (card.type === "used") {
          return card.port >= lockedStartPort && card.port <= lockedEndPort;
        } else if (card.type === "gap" || card.type === "unknown_range") {
          return !(
            card.end_port < lockedStartPort || card.start_port > lockedEndPort
          );
        }

        return false;
      }

      // è¿‡æ»¤ç«¯å£æ•°æ®
      function filterPorts(data) {
        if (!data.port_cards) return data;

        let filteredCards = data.port_cards.filter((card) => {
          const isHidden = isPortHidden(card);
          const inRange = isPortInRange(card);

          switch (currentFilter) {
            case "all":
              return !isHidden && inRange;
            case "system":
              return (
                !isHidden &&
                inRange &&
                (card.type === "used" || card.type === "unknown_range") &&
                card.source === "system"
              );
            case "container":
              return (
                !isHidden &&
                inRange &&
                (card.type === "used" || card.type === "unknown_range") &&
                card.source === "docker"
              );
            case "unused":
              return !isHidden && inRange && card.type === "gap";
            case "hidden":
              return isHidden && inRange;
            default:
              return !isHidden && inRange;
          }
        });

        if (currentFilter === "hidden") {
          const existingHiddenPorts = new Set();
          filteredCards.forEach((card) => {
            if (card.type === "used") {
              existingHiddenPorts.add(card.port);
            } else if (card.type === "unknown_range") {
              for (let port = card.start_port; port <= card.end_port; port++) {
                if (hiddenPorts.includes(port)) {
                  existingHiddenPorts.add(port);
                }
              }
            }
          });

          const virtualPorts = [];
          hiddenPorts.forEach((port) => {
            if (!existingHiddenPorts.has(port)) {
              virtualPorts.push({
                type: "used",
                port: port,
                service_name: "å·²éšè—ç«¯å£",
                source: "system",
                protocol: "TCP",
                container: null,
                is_host_network: false,
                is_virtual: true,
              });
            }
          });

          if (virtualPorts.length > 0) {
            virtualPorts.sort((a, b) => a.port - b.port);

            let i = 0;
            while (i < virtualPorts.length) {
              const currentPort = virtualPorts[i];
              const consecutiveHidden = [currentPort];
              let j = i + 1;

              while (
                j < virtualPorts.length &&
                virtualPorts[j].port === virtualPorts[j - 1].port + 1
              ) {
                consecutiveHidden.push(virtualPorts[j]);
                j++;
              }

              if (consecutiveHidden.length >= 2) {
                const startPort = consecutiveHidden[0].port;
                const endPort =
                  consecutiveHidden[consecutiveHidden.length - 1].port;

                const mergedCard = {
                  type: "unknown_range",
                  start_port: startPort,
                  end_port: endPort,
                  port_count: consecutiveHidden.length,
                  source: "system",
                  protocol: "TCP",
                  service_name: "å·²éšè—ç«¯å£",
                  container: null,
                  is_host_network: false,
                  is_virtual: true,
                };
                filteredCards.push(mergedCard);
              } else {
                filteredCards.push(currentPort);
              }

              i = j;
            }
          }

          filteredCards.sort((a, b) => {
            const portA = a.port || a.start_port;
            const portB = b.port || b.start_port;
            return portA - portB;
          });
        }

        if (currentFilter === "hidden") {
          console.log("éšè—ç«¯å£è¿‡æ»¤ç»“æœ:", filteredCards.length, "ä¸ªç«¯å£");
        }

        return {
          ...data,
          port_cards: filteredCards,
        };
      }

      /**
       * æ‰§è¡Œæœç´¢
       */
      async function performSearch() {
        const searchTerm = document.getElementById("searchInput").value.trim();

        if (isLoading) return;

        isLoading = true;
        const loadingEl = document.getElementById("loading");
        const errorEl = document.getElementById("error");
        const containerEl = document.getElementById("portsContainer");

        loadingEl.style.display = "block";
        errorEl.style.display = "none";
        containerEl.style.display = "none";

        try {
          let url = "/api/ports";
          const params = new URLSearchParams();

          if (searchTerm) {
            params.append("search", searchTerm);
          }
          if (currentProtocol !== "all") {
            params.append("protocol", currentProtocol.toUpperCase());
          }

          if (isPortRangeLocked && lockedStartPort && lockedEndPort) {
            params.append("start_port", lockedStartPort.toString());
            params.append("end_port", lockedEndPort.toString());
          }

          if (params.toString()) {
            url += "?" + params.toString();
          }

          const response = await fetch(url);
          const result = await response.json();

          if (result.success) {
            portsData = result.data;
            displayPorts(filterPorts(portsData));
            updateStats(portsData);
          } else {
            showError("æœç´¢å¤±è´¥: " + result.error);
          }
        } catch (error) {
          console.error("æœç´¢å¤±è´¥:", error);
          showError("æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
        } finally {
          isLoading = false;
          loadingEl.style.display = "none";
        }
      }

      /**
       * åŠ è½½ç«¯å£æ•°æ®
       */
      async function loadPorts() {
        if (isLoading) return;

        isLoading = true;
        const loadingEl = document.getElementById("loading");
        const errorEl = document.getElementById("error");
        const containerEl = document.getElementById("portsContainer");
        const refreshBtn = document.getElementById("refreshBtn");

        loadingEl.style.display = "block";
        errorEl.style.display = "none";
        containerEl.style.display = "none";
        refreshBtn.disabled = true;

        try {
          document.getElementById("searchInput").value = "";

          let apiUrl = "/api/ports";
          const params = new URLSearchParams();

          if (currentProtocol !== "all") {
            params.append("protocol", currentProtocol.toUpperCase());
          }

          if (isPortRangeLocked && lockedStartPort && lockedEndPort) {
            params.append("start_port", lockedStartPort.toString());
            params.append("end_port", lockedEndPort.toString());
          }

          if (params.toString()) {
            apiUrl += "?" + params.toString();
          }

          const response = await fetch(apiUrl);
          const result = await response.json();

          if (result.success) {
            portsData = result.data;
            displayPorts(filterPorts(portsData));
            updateStats(portsData);
          } else {
            showError("è·å–ç«¯å£æ•°æ®å¤±è´¥: " + result.error);
          }
        } catch (error) {
          console.error("åŠ è½½ç«¯å£æ•°æ®å¤±è´¥:", error);
          showError("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ");
        } finally {
          isLoading = false;
          loadingEl.style.display = "none";
          refreshBtn.disabled = false;
        }
      }

      /**
       * æ ¼å¼åŒ–ç«¯å£èŒƒå›´æ˜¾ç¤º
       */
      function formatPortRange(startPort, endPort) {
        const range = endPort - startPort + 1;
        if (range <= 1) {
          return startPort.toString();
        }
        return `${startPort}:${range}`;
      }

      /**
       * æ¸²æŸ“åè®®æ ‡ç­¾
       */
      function renderProtocolBadges(protocol) {
        if (!protocol) return "";

        const protocols =
          typeof protocol === "string"
            ? protocol.split(",").map((p) => p.trim())
            : [protocol];

        return protocols
          .map((p) => {
            const upperProtocol = p.toUpperCase();
            let color = "#666";
            let bgColor = "#e2e8f0";

            if (upperProtocol === "TCP") {
              color = "#2563eb";
              bgColor = "#dbeafe";
            } else if (upperProtocol === "UDP") {
              color = "#dc2626";
              bgColor = "#fee2e2";
            }

            return `<span style="font-size: 0.6rem; color: ${color}; background: ${bgColor}; padding: 0.1rem 0.3rem; border-radius: 3px; margin-right: 0.2rem;">${upperProtocol}</span>`;
          })
          .join("");
      }

      /**
       * æ˜¾ç¤ºç«¯å£å¡ç‰‡
       */
      function displayPorts(data) {
        const container = document.getElementById("portsContainer");
        container.innerHTML = "";

        if (!data.port_cards || data.port_cards.length === 0) {
          let emptyMessage = "";
          if (currentFilter === "hidden") {
            emptyMessage = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‘ï¸</div>
                            <h3>æš‚æ— éšè—ç«¯å£</h3>
                            <p>æ‚¨è¿˜æ²¡æœ‰éšè—ä»»ä½•ç«¯å£</p>
                        </div>
                    `;
          } else {
            emptyMessage =
              '<p style="text-align: center; color: white; grid-column: 1 / -1;">æš‚æ— ç«¯å£æ•°æ®</p>';
          }
          container.innerHTML = emptyMessage;
          container.style.display =
            currentFilter === "hidden" ? "block" : "grid";
          return;
        }

        data.port_cards.forEach((card) => {
          const isHidden = isPortHidden(card);
          const isVirtual = card.is_virtual || false;

          const cardEl = document.createElement("div");
          cardEl.className = `port-card${isHidden ? " hidden" : ""}${
            isVirtual ? " virtual" : ""
          }`;

          const listEl = document.createElement("div");
          listEl.className = `port-list-item${isHidden ? " hidden" : ""}${
            isVirtual ? " virtual" : ""
          }`;

          if (card.type === "used") {
            cardEl.classList.add("used");
            listEl.classList.add("used");
            if (card.source === "docker") {
              cardEl.classList.add("docker");
              listEl.style.borderLeftColor = "#4299e1";
            } else {
              cardEl.classList.add("system");
              listEl.style.borderLeftColor = "#48bb78";
            }

            const displayName =
              card.service_name ||
              (card.source === "docker"
                ? card.container || card.container_name || "Dockerå®¹å™¨"
                : card.process || "ç³»ç»ŸæœåŠ¡");
            const fullName = displayName;

            let portDisplayHtml = "";
            if (card.source === "docker" && card.container_port) {
              portDisplayHtml = `
                            <div class="port-display">
                                <div class="host-port">${card.port}</div>
                                <div class="mapped-port">(${card.container_port})</div>
                            </div>
                        `;
            } else if (card.source === "docker" && card.is_host_network) {
              portDisplayHtml = `
                            <div class="port-display">
                                <div class="host-port">${card.port}</div>
                                <div class="mapped-port">(host)</div>
                            </div>
                        `;
            } else {
              portDisplayHtml = `<div class="port-number">${card.port}</div>`;
            }

            const isUnknownService = displayName === "æœªçŸ¥æœåŠ¡";

            cardEl.innerHTML = `
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                            ${portDisplayHtml}
                            <div class="tooltip">
                                <div class="service-name">${displayName}</div>
                                ${
                                  fullName.length > 15
                                    ? `<span class="tooltiptext">${fullName}</span>`
                                    : ""
                                }
                            </div>
                            ${
                              card.protocol
                                ? `<div style="margin-top: 0.2rem;">${renderProtocolBadges(
                                    card.protocol
                                  )}</div>`
                                : ""
                            }
                        </div>
                        <div class="port-card-footer">
                            <div class="port-card-actions">
                                ${
                                  isUnknownService
                                    ? `<button class="add-port-btn" onclick="editPortName(${card.port})" title="æ·»åŠ ç«¯å£åˆ°é…ç½®æ–‡ä»¶">+</button>`
                                    : ""
                                }
                            </div>
                            <div class="port-card-center">
                                <span class="port-source-badge ${
                                  card.source
                                }">${
              card.source === "docker" ? "Docker" : "å®¿ä¸»æœº"
            }</span>
                            </div>
                            <div class="port-card-actions">
                                ${
                                  isHidden
                                    ? `<button class="hide-port-btn" onclick="unhidePort(${card.port})" title="å–æ¶ˆéšè—æ­¤ç«¯å£">ğŸ‘ï¸</button>`
                                    : `<button class="hide-port-btn" onclick="hidePort(${card.port})" title="éšè—æ­¤ç«¯å£">ğŸ‘ï¸â€ğŸ—¨ï¸</button>`
                                }
                            </div>
                        </div>
                    `;

            let listPortDisplay = "";
            if (card.source === "docker" && card.container_port) {
              listPortDisplay = `${card.port} <span style="font-size: 0.8rem; color: #999;">(${card.container_port})</span>`;
            } else if (card.source === "docker" && card.is_host_network) {
              listPortDisplay = `${card.port} <span style="font-size: 0.8rem; color: #999;">(host)</span>`;
            } else {
              listPortDisplay = card.port;
            }

            listEl.innerHTML = `
                         <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                             <div style="font-size: 1.2rem; font-weight: bold; min-width: 80px; color: ${
                               card.source === "docker" ? "#4299e1" : "#48bb78"
                             };">${listPortDisplay}</div>
                             <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0;">
                                 <span>${
                                   card.source === "docker" ? "ğŸ³" : "âš™ï¸"
                                 }</span>
                                 <div class="tooltip" style="flex: 1; min-width: 0;">
                                     <div class="process-name">${displayName}</div>
                                     ${
                                       fullName.length > 20
                                         ? `<span class="tooltiptext">${fullName}</span>`
                                         : ""
                                     }
                                 </div>
                             </div>
                             <div style="display: flex; gap: 0.5rem; align-items: center; height: 24px;">
                                 ${
                                   card.protocol
                                     ? renderProtocolBadges(card.protocol)
                                     : ""
                                 }
                                 ${
                                   isUnknownService
                                     ? `<button class="add-port-btn list-add-btn" onclick="editPortName(${card.port})" title="æ·»åŠ ç«¯å£åˆ°é…ç½®æ–‡ä»¶">+</button>`
                                     : ""
                                 }
                                 <span class="port-source-badge ${
                                   card.source
                                 }" style="height: 20px; display: flex; align-items: center; line-height: 20px;">${
              card.source === "docker" ? "Docker" : "å®¿ä¸»æœº"
            }</span>
                                 ${
                                   isHidden
                                     ? `<button class="hide-port-btn list-hide-btn" onclick="unhidePort(${card.port})" title="å–æ¶ˆéšè—æ­¤ç«¯å£">ğŸ‘ï¸</button>`
                                     : `<button class="hide-port-btn list-hide-btn" onclick="hidePort(${card.port})" title="éšè—æ­¤ç«¯å£">ğŸ‘ï¸â€ğŸ—¨ï¸</button>`
                                 }
                             </div>
                         </div>
                     `;
          } else if (card.type === "gap") {
            cardEl.classList.add("gap");
            listEl.classList.add("gap");
            listEl.style.borderLeftColor = "#e2e8f0";

            cardEl.innerHTML = `
                        <div class="port-number">â‹¯</div>
                        <div class="gap-info">${formatPortRange(
                          card.start_port,
                          card.end_port
                        )}</div>
                        <div class="gap-info">${
                          card.available_count
                        } ä¸ªå¯ç”¨ç«¯å£</div>
                    `;

            listEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <div style="font-size: 1rem; color: #a0aec0; min-width: 60px;">â‹¯</div>
                            <div style="color: #718096;">${formatPortRange(
                              card.start_port,
                              card.end_port
                            )}</div>
                            <div style="font-size: 0.9rem; color: #718096;">${
                              card.available_count
                            } ä¸ªå¯ç”¨ç«¯å£</div>
                        </div>
                        <div style="font-size: 0.8rem; color: #a0aec0;">å¯ç”¨èŒƒå›´</div>
                    `;
          } else if (card.type === "unknown_range") {
            cardEl.classList.add("used");
            listEl.classList.add("used");
            if (card.source === "docker") {
              cardEl.classList.add("docker");
              listEl.style.borderLeftColor = "#4299e1";
            } else {
              cardEl.classList.add("system");
              listEl.style.borderLeftColor = "#48bb78";
            }

            cardEl.innerHTML = `
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                            <div class="port-number">${formatPortRange(
                              card.start_port,
                              card.end_port
                            )}</div>
                            <div class="tooltip">
                                <div class="service-name">æœªçŸ¥æœåŠ¡ (${
                                  card.port_count
                                }ä¸ªç«¯å£)</div>
                            </div>
                            ${
                              card.protocol
                                ? `<div style="margin-top: 0.2rem;">${renderProtocolBadges(
                                    card.protocol
                                  )}</div>`
                                : ""
                            }
                        </div>
                        <div class="port-card-footer">
                            <div class="port-card-actions">
                                <button class="add-port-btn" onclick="editPortRangeName(${
                                  card.start_port
                                }, ${
              card.end_port
            })" title="æ‰¹é‡æ·»åŠ ç«¯å£åˆ°é…ç½®æ–‡ä»¶">+</button>
                            </div>
                            <div class="port-card-center">
                                <span class="port-source-badge ${
                                  card.source
                                }">${
              card.source === "docker" ? "Docker" : "å®¿ä¸»æœº"
            }</span>
                            </div>
                            <div class="port-card-actions">
                                ${
                                  isHidden
                                    ? `<button class="hide-port-btn" onclick="unhidePortRange(${card.start_port}, ${card.end_port})" title="å–æ¶ˆéšè—æ­¤ç«¯å£èŒƒå›´">ğŸ‘ï¸</button>`
                                    : `<button class="hide-port-btn" onclick="hidePortRange(${card.start_port}, ${card.end_port})" title="éšè—æ­¤ç«¯å£èŒƒå›´">ğŸ‘ï¸â€ğŸ—¨ï¸</button>`
                                }
                            </div>
                        </div>
                    `;

            listEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <div style="font-size: 1.2rem; font-weight: bold; min-width: 80px; color: ${
                              card.source === "docker" ? "#4299e1" : "#48bb78"
                            };">${formatPortRange(
              card.start_port,
              card.end_port
            )}</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0;">
                                <span>${
                                  card.source === "docker" ? "ğŸ³" : "âš™ï¸"
                                }</span>
                                <div class="tooltip" style="flex: 1; min-width: 0;">
                                    <div class="process-name">æœªçŸ¥æœåŠ¡ (${
                                      card.port_count
                                    }ä¸ªç«¯å£)</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; height: 24px;">
                                ${
                                  card.protocol
                                    ? `<span style="font-size: 0.7rem; color: #666; background: #e2e8f0; padding: 0.2rem 0.4rem; border-radius: 4px; height: 20px; display: flex; align-items: center; line-height: 20px;">${card.protocol.toUpperCase()}</span>`
                                    : ""
                                }
                                <button class="add-port-btn list-add-btn" onclick="editPortRangeName(${
                                  card.start_port
                                }, ${
              card.end_port
            })" title="æ‰¹é‡æ·»åŠ ç«¯å£åˆ°é…ç½®æ–‡ä»¶">+</button>
                                <span class="port-source-badge ${
                                  card.source
                                }" style="height: 20px; display: flex; align-items: center; line-height: 20px;">${
              card.source === "docker" ? "Docker" : "å®¿ä¸»æœº"
            }</span>
                                ${
                                  isHidden
                                    ? `<button class="hide-port-btn list-hide-btn" onclick="unhidePortRange(${card.start_port}, ${card.end_port})" title="å–æ¶ˆéšè—æ­¤ç«¯å£èŒƒå›´">ğŸ‘ï¸</button>`
                                    : `<button class="hide-port-btn list-hide-btn" onclick="hidePortRange(${card.start_port}, ${card.end_port})" title="éšè—æ­¤ç«¯å£èŒƒå›´">ğŸ‘ï¸â€ğŸ—¨ï¸</button>`
                                }
                            </div>
                        </div>
                    `;
          }

          container.appendChild(cardEl);
          container.appendChild(listEl);
        });

        container.style.display = currentView === "card" ? "grid" : "block";
      }

      /**
       * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
       */
      function updateStats(data) {
        document.getElementById("totalUsed").textContent = data.total_used || 0;
        document.getElementById("totalAvailable").textContent =
          data.total_available || 0;
        document.getElementById("dockerContainers").textContent =
          data.docker_containers || 0;
        document.getElementById("tcpUsed").textContent = data.tcp_used || 0;
        document.getElementById("udpUsed").textContent = data.udp_used || 0;
      }

      /**
       * åˆ·æ–°ç«¯å£æ•°æ®
       */
      async function refreshPorts() {
        if (isLoading) return;

        isLoading = true;
        const refreshBtn = document.getElementById("refreshBtn");
        refreshBtn.disabled = true;
        refreshBtn.textContent = "ğŸ”„ åˆ·æ–°ä¸­...";

        try {
          const response = await fetch("/api/refresh");
          const result = await response.json();

          if (result.success) {
            displayPorts(result.data);
            updateStats(result.data);

            refreshBtn.textContent = "âœ… åˆ·æ–°æˆåŠŸ";
            setTimeout(() => {
              refreshBtn.textContent = "ğŸ”„ åˆ·æ–°æ•°æ®";
            }, 2000);
          } else {
            showError("åˆ·æ–°å¤±è´¥: " + result.error);
            refreshBtn.textContent = "âŒ åˆ·æ–°å¤±è´¥";
            setTimeout(() => {
              refreshBtn.textContent = "ğŸ”„ åˆ·æ–°æ•°æ®";
            }, 2000);
          }
        } catch (error) {
          console.error("åˆ·æ–°å¤±è´¥:", error);
          showError("åˆ·æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
          refreshBtn.textContent = "âŒ åˆ·æ–°å¤±è´¥";
          setTimeout(() => {
            refreshBtn.textContent = "ğŸ”„ åˆ·æ–°æ•°æ®";
          }, 2000);
        } finally {
          isLoading = false;
          refreshBtn.disabled = false;
        }
      }

      /**
       * è®¾ç½®ç®¡ç†åŠŸèƒ½
       */
      let currentConfig = null;

      /**
       * æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
       */
      async function openSettings() {
        try {
          // æ£€æŸ¥æƒé™
          if (!currentUser) {
            alert("è¯·å…ˆç™»å½•");
            return;
          }

          const response = await fetch("/api/config/raw");
          const rawConfig = await response.json();
          currentConfig = rawConfig;

          const configEditor = document.getElementById("configEditor");
          configEditor.value = JSON.stringify(rawConfig, null, 2);

          document.getElementById("configError").style.display = "none";

          document.getElementById("settingsModal").style.display = "block";
        } catch (error) {
          console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
          alert("åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
      }

      /**
       * å…³é—­è®¾ç½®æ¨¡æ€æ¡†
       */
      function closeSettings() {
        document.getElementById("settingsModal").style.display = "none";
      }

      /**
       * ä¿å­˜è®¾ç½®
       */
      async function saveSettings() {
        try {
          const configEditor = document.getElementById("configEditor");
          const configError = document.getElementById("configError");

          configError.style.display = "none";

          let newConfig;
          try {
            newConfig = JSON.parse(configEditor.value);
          } catch (parseError) {
            configError.textContent = "JSONæ ¼å¼é”™è¯¯: " + parseError.message;
            configError.style.display = "block";
            return;
          }

          if (typeof newConfig !== "object" || newConfig === null) {
            configError.textContent = "é…ç½®å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONå¯¹è±¡";
            configError.style.display = "block";
            return;
          }

          for (const [name, value] of Object.entries(newConfig)) {
            if (name !== "app_settings") {
              let port;
              let serviceName = name;
              let serviceType = "host";

              if (
                name.includes(":") &&
                (name.endsWith(":docker") || name.endsWith(":host"))
              ) {
                const parts = name.split(":");
                serviceName = parts.slice(0, -1).join(":");
                serviceType = parts[parts.length - 1];

                if (serviceType !== "docker" && serviceType !== "host") {
                  configError.textContent = `é…ç½®é¡¹ "${name}" çš„æœåŠ¡ç±»å‹ "${serviceType}" æ— æ•ˆï¼Œåªæ”¯æŒdockeræˆ–host`;
                  configError.style.display = "block";
                  return;
                }
              }

              if (typeof value === "number") {
                port = value;
              } else if (typeof value === "string") {
                const parts = value.split(":");
                if (parts.length >= 2) {
                  port = parseInt(parts[0]);
                  if (isNaN(port)) {
                    configError.textContent = `é…ç½®é¡¹ "${name}" çš„ç«¯å£å· "${parts[0]}" æ— æ•ˆ`;
                    configError.style.display = "block";
                    return;
                  }
                  const protocol = parts[1].toLowerCase();
                  if (protocol !== "tcp" && protocol !== "udp") {
                    configError.textContent = `é…ç½®é¡¹ "${name}" çš„åè®® "${parts[1]}" æ— æ•ˆï¼Œåªæ”¯æŒtcpæˆ–udp`;
                    configError.style.display = "block";
                    return;
                  }
                } else {
                  configError.textContent = `é…ç½®é¡¹ "${name}" çš„æ ¼å¼æ— æ•ˆï¼Œæ–°æ ¼å¼åº”ä¸º "ç«¯å£å·:åè®®"`;
                  configError.style.display = "block";
                  return;
                }
              } else if (
                typeof value === "object" &&
                value !== null &&
                value.port
              ) {
                port = value.port;
                if (value.protocol && typeof value.protocol === "string") {
                  const protocol = value.protocol.toLowerCase();
                  if (protocol !== "tcp" && protocol !== "udp") {
                    configError.textContent = `é…ç½®é¡¹ "${name}" çš„åè®® "${value.protocol}" æ— æ•ˆï¼Œåªæ”¯æŒTCPæˆ–UDP`;
                    configError.style.display = "block";
                    return;
                  }
                }
              } else {
                configError.textContent = `é…ç½®é¡¹ "${name}" çš„æ ¼å¼æ— æ•ˆï¼Œæ–°æ ¼å¼ï¼š"æœåŠ¡å:docker/host":"ç«¯å£å·:åè®®"`;
                configError.style.display = "block";
                return;
              }

              if (!Number.isInteger(port) || port < 1 || port > 65535) {
                configError.textContent = `ç«¯å£ "${name}" çš„å€¼ "${port}" æ— æ•ˆï¼Œå¿…é¡»æ˜¯1-65535ä¹‹é—´çš„æ•´æ•°`;
                configError.style.display = "block";
                return;
              }
            }
          }

          const response = await fetch("/api/config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(newConfig),
          });

          const result = await response.json();

          if (result.success) {
            alert("é…ç½®ä¿å­˜æˆåŠŸï¼");
            closeSettings();
            loadPorts();
          } else {
            configError.textContent =
              "ä¿å­˜å¤±è´¥: " + (result.error || "æœªçŸ¥é”™è¯¯");
            configError.style.display = "block";
          }
        } catch (error) {
          console.error("ä¿å­˜é…ç½®å¤±è´¥:", error);
          const configError = document.getElementById("configError");
          configError.textContent = "ä¿å­˜å¤±è´¥: " + error.message;
          configError.style.display = "block";
        }
      }

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      window.onclick = function (event) {
        const modal = document.getElementById("settingsModal");
        if (event.target === modal) {
          closeSettings();
        }
      };

      // ç¼–è¾‘ç«¯å£åç§°åŠŸèƒ½
      function editPortName(port) {
        const modal = document.createElement("div");
        modal.className = "edit-modal";
        modal.innerHTML = `
                <div class="edit-modal-content">
                    <h3>ç¼–è¾‘ç«¯å£ ${port} çš„æœåŠ¡é…ç½®</h3>
                    <div style="margin-bottom: 1rem;">
                        <label for="portNameInput" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æœåŠ¡åç§°:</label>
                        <input type="text" id="portNameInput" placeholder="è¯·è¾“å…¥æœåŠ¡åç§°" maxlength="50" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="serviceTypeSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æœåŠ¡ç±»å‹:</label>
                        <select id="serviceTypeSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px;">
                            <option value="host">å®¿ä¸»æœºæœåŠ¡</option>
                            <option value="docker">Dockerå®¹å™¨</option>
                        </select>
                    </div>
                    <div class="edit-modal-buttons">
                        <button class="cancel-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                        <button class="save-btn" onclick="savePortName(${port})">ä¿å­˜</button>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);

        const input = document.getElementById("portNameInput");
        input.focus();

        input.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            savePortName(port);
          }
        });

        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            closeEditModal();
          }
        });
      }

      function closeEditModal() {
        const modal = document.querySelector(".edit-modal");
        if (modal) {
          modal.remove();
        }
      }

      function savePortName(port) {
        const input = document.getElementById("portNameInput");
        const serviceTypeSelect = document.getElementById("serviceTypeSelect");
        const serviceName = input.value.trim();
        const serviceType = serviceTypeSelect.value;

        if (!serviceName) {
          alert("è¯·è¾“å…¥æœåŠ¡åç§°");
          return;
        }

        fetch("/api/config", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            port: port,
            service_name: serviceName,
            service_type: serviceType,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              closeEditModal();
              loadPorts();
              showMessage("ç«¯å£é…ç½®å·²ä¿å­˜", "success");
            } else {
              alert("ä¿å­˜å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
            }
          })
          .catch((error) => {
            console.error("ä¿å­˜ç«¯å£é…ç½®æ—¶å‡ºé”™:", error);
            alert("ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          });
      }

      // ç¼–è¾‘ç«¯å£èŒƒå›´åç§°åŠŸèƒ½
      function editPortRangeName(startPort, endPort) {
        const modal = document.createElement("div");
        modal.className = "edit-modal";
        modal.innerHTML = `
                <div class="edit-modal-content">
                    <h3>æ‰¹é‡ç¼–è¾‘ç«¯å£ ${startPort}-${endPort} çš„æœåŠ¡åç§°</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">æ­¤æ“ä½œå°†ä¸ºèŒƒå›´å†…çš„æ‰€æœ‰ç«¯å£è®¾ç½®ç›¸åŒçš„æœåŠ¡åç§°</p>
                    <input type="text" id="portRangeNameInput" placeholder="è¯·è¾“å…¥æœåŠ¡åç§°" maxlength="50">
                    <div class="edit-modal-buttons">
                        <button class="cancel-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                        <button class="save-btn" onclick="savePortRangeName(${startPort}, ${endPort})">ä¿å­˜</button>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);

        const input = document.getElementById("portRangeNameInput");
        input.focus();

        input.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            savePortRangeName(startPort, endPort);
          }
        });

        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            closeEditModal();
          }
        });
      }

      function savePortRangeName(startPort, endPort) {
        const input = document.getElementById("portRangeNameInput");
        const serviceName = input.value.trim();

        if (!serviceName) {
          alert("è¯·è¾“å…¥æœåŠ¡åç§°");
          return;
        }

        const promises = [];
        for (let port = startPort; port <= endPort; port++) {
          promises.push(
            fetch("/api/config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                port: port,
                service_name: serviceName,
              }),
            }).then((response) => response.json())
          );
        }

        Promise.all(promises)
          .then((results) => {
            const failedPorts = [];
            results.forEach((result, index) => {
              if (!result.success) {
                failedPorts.push(startPort + index);
              }
            });

            closeEditModal();

            if (failedPorts.length === 0) {
              loadPorts();
              showMessage(
                `æˆåŠŸä¿å­˜ ${endPort - startPort + 1} ä¸ªç«¯å£çš„é…ç½®`,
                "success"
              );
            } else {
              loadPorts();
              showMessage(
                `éƒ¨åˆ†ç«¯å£ä¿å­˜å¤±è´¥: ${failedPorts.join(", ")}`,
                "error"
              );
            }
          })
          .catch((error) => {
            console.error("æ‰¹é‡ä¿å­˜ç«¯å£é…ç½®æ—¶å‡ºé”™:", error);
            alert("ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          });
      }

      function showMessage(message, type = "info") {
        const messageEl = document.createElement("div");
        messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 3000;
                animation: slideIn 0.3s ease;
                background: ${
                  type === "success"
                    ? "#48bb78"
                    : type === "error"
                    ? "#e53e3e"
                    : "#4299e1"
                };
            `;
        messageEl.textContent = message;

        document.body.appendChild(messageEl);

        setTimeout(() => {
          messageEl.style.animation = "slideOut 0.3s ease";
          setTimeout(() => messageEl.remove(), 300);
        }, 3000);
      }

      // éšè—ç«¯å£åŠŸèƒ½
      async function loadHiddenPorts() {
        try {
          const response = await fetch("/api/hidden-ports");
          const result = await response.json();
          if (result.success) {
            hiddenPorts = result.data || [];
            console.log("éšè—ç«¯å£æ•°æ®åŠ è½½æˆåŠŸ:", hiddenPorts);
          } else {
            console.error("åŠ è½½éšè—ç«¯å£å¤±è´¥:", result.error);
          }
        } catch (error) {
          console.error("åŠ è½½éšè—ç«¯å£å¤±è´¥:", error);
        }
      }

      /**
       * éšè—å•ä¸ªç«¯å£
       */
      async function hidePort(port) {
        try {
          const response = await fetch("/api/hidden-ports", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ port: port }),
          });
          const result = await response.json();
          if (result.success) {
            if (!hiddenPorts.includes(port)) {
              hiddenPorts.push(port);
            }
            showMessage(`ç«¯å£ ${port} å·²éšè—`, "success");
            console.log("ç«¯å£éšè—æˆåŠŸï¼Œå½“å‰éšè—ç«¯å£åˆ—è¡¨:", hiddenPorts);
            loadPorts();
          } else {
            showMessage("éšè—ç«¯å£å¤±è´¥: " + result.error, "error");
          }
        } catch (error) {
          console.error("éšè—ç«¯å£å¤±è´¥:", error);
          showMessage("éšè—ç«¯å£å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
        }
      }

      /**
       * éšè—ç«¯å£èŒƒå›´
       */
      async function hidePortRange(startPort, endPort) {
        try {
          const ports = [];
          for (let port = startPort; port <= endPort; port++) {
            ports.push(port);
          }

          const response = await fetch("/api/hidden-ports/batch", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ ports: ports }),
          });
          const result = await response.json();
          if (result.success) {
            ports.forEach((port) => {
              if (!hiddenPorts.includes(port)) {
                hiddenPorts.push(port);
              }
            });
            showMessage(`ç«¯å£èŒƒå›´ ${startPort}-${endPort} å·²éšè—`, "success");
            loadPorts();
          } else {
            showMessage("éšè—ç«¯å£èŒƒå›´å¤±è´¥: " + result.error, "error");
          }
        } catch (error) {
          console.error("éšè—ç«¯å£èŒƒå›´å¤±è´¥:", error);
          showMessage("éšè—ç«¯å£èŒƒå›´å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
        }
      }

      /**
       * å–æ¶ˆéšè—å•ä¸ªç«¯å£
       */
      async function unhidePort(port) {
        try {
          const response = await fetch("/api/hidden-ports", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ port: port }),
          });
          const result = await response.json();
          if (result.success) {
            hiddenPorts = hiddenPorts.filter((p) => p !== port);
            showMessage(`ç«¯å£ ${port} å·²å–æ¶ˆéšè—`, "success");
            loadPorts();
          } else {
            showMessage("å–æ¶ˆéšè—ç«¯å£å¤±è´¥: " + result.error, "error");
          }
        } catch (error) {
          console.error("å–æ¶ˆéšè—ç«¯å£å¤±è´¥:", error);
          showMessage("å–æ¶ˆéšè—ç«¯å£å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
        }
      }

      /**
       * å–æ¶ˆéšè—ç«¯å£èŒƒå›´
       */
      async function unhidePortRange(startPort, endPort) {
        try {
          const ports = [];
          for (let port = startPort; port <= endPort; port++) {
            ports.push(port);
          }

          const response = await fetch("/api/hidden-ports/batch", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ ports: ports }),
          });
          const result = await response.json();
          if (result.success) {
            hiddenPorts = hiddenPorts.filter((p) => !ports.includes(p));
            showMessage(
              `ç«¯å£èŒƒå›´ ${startPort}-${endPort} å·²å–æ¶ˆéšè—`,
              "success"
            );
            loadPorts();
          } else {
            showMessage("å–æ¶ˆéšè—ç«¯å£èŒƒå›´å¤±è´¥: " + result.error, "error");
          }
        } catch (error) {
          console.error("å–æ¶ˆéšè—ç«¯å£èŒƒå›´å¤±è´¥:", error);
          showMessage("å–æ¶ˆéšè—ç«¯å£èŒƒå›´å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
        }
      }

      // æ·»åŠ åŠ¨ç”»æ ·å¼
      const style = document.createElement("style");
      style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
